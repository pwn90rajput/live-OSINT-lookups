<!doctype html>
async function sslLabs(domain){
$('#sslStatus').innerHTML='Starting SSL Labs scan…'; renderTable('#sslTable',['IP','Grade','Status'],[]);
let tries=0, started=false;
while(tries<25){
tries++;
try{
const url='https://api.ssllabs.com/api/v3/analyze?host='+encodeURIComponent(domain)+'&all=done'+(started?'&startNew=off':'&startNew=on');
const j=await getJSON(url);
const st=j.status||'UNKNOWN'; $('#sslStatus').innerHTML='SSL Labs: '+esc(st)+' ('+tries+')';
if(st==='READY' && Array.isArray(j.endpoints)){ const rows=j.endpoints.map(ep=>[ep.ipAddress||'', ep.grade||'', ep.statusMessage||'']); renderTable('#sslTable',['IP','Grade','Status'],rows); $('#sslStatus').innerHTML='SSL Labs: READY'; return rows; }
if(st==='ERROR' || st==='DNS'){ $('#sslStatus').innerHTML='SSL Labs: '+esc(st); return []; }
}catch(e){}
started=true; await sleep(6000);
}
$('#sslStatus').innerHTML='SSL Labs: Timed out / no result';
return [];
}


// ===== Public Emails (improved relevance) =====
const COMMON_PORTS={25:'smtp',53:'dns',80:'http',110:'pop3',123:'ntp',143:'imap',389:'ldap',443:'https',465:'smtps',514:'syslog',587:'submission',631:'ipp',636:'ldaps',853:'dot',993:'imaps',995:'pop3s',1433:'mssql',1521:'oracle',2049:'nfs',2083:'cpanel',2087:'whm',2089:'whm',2181:'zookeeper',2375:'docker',2376:'dockers',27017:'mongodb',27018:'mongodb',3306:'mysql',3389:'rdp',4000:'webhooks',4040:'spark',4369:'epmd',5000:'flask',5432:'postgres',5601:'kibana',5672:'amqp',5900:'vnc',5985:'winrm',5986:'winrms',6379:'redis',6443:'kubeapi',7001:'weblogic',7002:'weblogic',7077:'spark',8000:'http-alt',8008:'http-alt',8080:'http-proxy',8081:'http-alt',8088:'hadoop',8443:'https-alt',8500:'consul',9000:'sentry',9200:'elasticsearch',9300:'es-internal',11211:'memcached'};


function extractEmails(text){ const re=/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi; return [...new Set((text.match(re)||[]))]; }
function rdapEmails(r){ const out=new Set(); try{ for(const ent of (r.entities||[])){ const va=ent.vcardArray && ent.vcardArray[1] || []; for(const it of va){ if(Array.isArray(it) && it[0]==='email'){ const v=(it[3]||'').toString(); if(v) out.add(v); } } } }catch(e){} return [...out]; }
function relatedToDomain(email, domain){ if(!email) return false; const parts=email.split('@'); if(parts.length!==2) return false; const host=parts[1].toLowerCase(); return host===domain || host.endsWith('.'+domain); }
async function gatherPublicEmails(domain, txtRecords, rdapObj){
setProgress('Gathering public emails…');
const base='https://'+domain;
const pages=['/','.well-known/security.txt','/security.txt','/contact','/contact-us','/contacts','/about','/team','/careers','/support','/help','/legal','/privacy','/terms','/impressum','/robots.txt','/sitemap.xml'];
const found=new Set();
// DMARC rua/ruf
for(const t of (txtRecords||[])){ const m=t.match(/ru[af]=mailto:([^,\s]+)/gi); if(m){ m.forEach(s=>found.add(s.split(':').pop())); } }
// SOA RNAME
try{ const soa=await doh(domain,'SOA'); if(soa&&soa[0]){ const parts=soa[0].split(' '); if(parts[1]){ const rname=parts[1].replace(/\.$/,'').replace(/\./g,'@'); if(/@/.test(rname)) found.add(rname); } } }catch{}
// RDAP entity emails
rdapEmails(rdapObj||{}).forEach(e=>found.add(e));
// Site pages
for(const p of pages){ const html=await getText(base.replace(/\/$/,'')+p); if(!html) continue; extractEmails(html).forEach(e=>found.add(e)); const mailtos=[...html.matchAll(/mailto:([^"'>\s]+)/gi)].map(m=>m[1].split('?')[0]); mailtos.forEach(e=>found.add(e)); }
// GitHub code search (best-effort via mirror)
try{ const gh=await getText('https://github.com/search?q=%40'+encodeURIComponent(domain)+'&type=code'); extractEmails(gh).forEach(e=>found.add(e)); }catch{}
// Basic public web search page (DuckDuckGo HTML)
try{ const ddg=await getText('https://duckduckgo.com/html/?q='+encodeURIComponent('@'+domain)); extractEmails(ddg).forEach(e=>found.add(e)); }catch{}
// Filter to relevant domain emails only, remove junk
const list=[...found].filter(e=>relatedToDomain(e.toLowerCase(), domain)).sort();
renderTable('#emails',['Email'], list.map(e=>[e]));
return list;
}


// ===== Branding & Socials =====
async function fetchBranding(domain){
setProgress('Discovering branding…');
const base='https://'+domain; const html=await getText(base);
const out=[]; const logos=$('#logos'); if(logos) logos.innerHTML='';
if(html){
const iconTags=[...html.matchAll(/<link[^>]+rel=["'](?:icon|shortcut icon|apple-touch-icon)["'][^>]*>/gi)].map(m=>m[0]);
const iconHrefs=iconTags.map(tag=> (tag.match(/href=["']([^"']+)/i)||[])[1]).filter(Boolean)
.map(h=>{ try{ return new URL(h,base).href; }catch(e){ return h; } });
const og=(html.match(/property=["']og:image["'][^>]*content=["']([^"']+)/i)||[])[1];
if(og){ try{ iconHrefs.push(new URL(og,base).href); }catch(e){ iconHrefs.push(og); } }
const imgs=[...new Set(iconHrefs)];
imgs.forEach(src=>{ const img=new Image(); img.src=src; img.alt='logo'; logos?.appendChild(img); out.push(['Icon',src]); });
}
const cb='https://logo.clearbit.com/'+domain; out.push(['Clearbit',cb]); const cbimg=new Image(); cbimg.src=cb; cbimg.alt='clearbit'; $('#logos')?.appendChild(cbimg);
const tb=$('#branding'); tb.querySelector('thead').innerHTML='<tr><th>Source</th><th>URL</th></tr>';
tb.querySelector('tbody').innerHTML= out.map(([k,u])=>'<tr><td>'+esc(k)+'</td><td><a target="_blank" rel="noreferrer" href="'+esc(u)+'">'+esc(u)+'</a></td></tr>').join('');
return out;
}
async function findSocials(domain){
setProgress('Finding social profiles…');
const base='https://'+domain; const html=await getText(base); const rows=[]; if(!html){ renderTable('#social',["Network","URL"],[]); return []; }
function grab(re){ return [...new Set((html.match(re)||[]))]; }
const links=[ ...grab(/https?:\/\/([a-z]+\.)?linkedin\.com\/[A-Za-z0-9_\-\/]+/gi),
...grab(/https?:\/\/twitter\.com\/[A-Za-z0-9_]+/gi),
...grab(/https?:\/\/x\.com\/[A-Za-z0-9_]+/gi),
...grab(/https?:\/\/facebook\.com\/[A-Za-z0-9_.\-\/]+/gi),
...grab(/https?:\/\/www\.youtube\.com\/[A-Za-z0-9_.\-\/]+/gi),
...grab(/https?:\/\/instagram\.com\/[A-Za-z0-9_.\-\/]+/gi)];
const uniq=[...new Set(links)];
uniq.forEach(u=>{ let n='Other'; if(/linkedin/i.test(u)) n='LinkedIn'; else if(/twitter|x\.com/i.test(u)) n='Twitter/X';
else if(/facebook/i.test(u)) n='Facebook'; else if(/youtube/i.test(u)) n='YouTube'; else if(/instagram/i.test(u)) n='Instagram'; rows.push([n,u]); });
renderTable('#social',['Network','URL'], rows);
return rows;
}


// ===== Typosquats (light dnstwist) & takeover hints =====
const takeoverHints=[/\.github\.io$/i,/\.herokuapp\.com$/i,/\.azurewebsites\.net$/i,/\.cloudfront\.net$/i,/\.amazonaws\.com$/i,/\.netlify\.app$/i,/\.readthedocs\.io$/i,/\.fastly\.net$/i,/\.pages\.dev$/i];

async function typosAndTakeover(domain){
  setProgress('Generating typo domains…');
  const candidates=dnstwistCandidates(domain).slice(0,200);
  const rows=[]; let i=0; const workers=8;
  async function w(){
    while(i<candidates.length){
      const idx=i++; const d=candidates[idx]; let A=[], C=[];
      try{ A=await doh(d,'A'); }catch{} try{ C=await doh(d,'CNAME'); }catch{}
      const cname=(C||[])[0]||''; 
      const provider = takeoverHints.find(re=>re.test((cname||'').toLowerCase())) ? '3rd-party CNAME' : '';
      if((A&&A.length) || cname){ rows.push([d,(A||[])[0]||'', cname, provider]); }
      setProgress(`Typosquats checked ${idx+1}/${candidates.length}`);
    }
  }
  await Promise.all(Array.from({length:workers}, w));
  rows.sort((a,b)=>a[0].localeCompare(b[0]));
  renderTable('#typos',['Domain','First A','CNAME','Hint'], rows);
  return rows;
}

// ===== Nmap-like Open Ports Section (via Shodan InternetDB) =====
async function openPorts(domain){
  setProgress('Fetching open ports (Shodan InternetDB)…');
  let A=[]; try{ A=await doh(domain,'A'); }catch{}
  const ip = (A||[])[0];
  if(!ip){ renderTable('#openports',['Port','Service'],[]); return []; }
  try{
    const data=await getJSON('https://internetdb.shodan.io/'+encodeURIComponent(ip));
    const ports=(data.ports||[]).map(p=>[String(p), COMMON_PORTS[p]||'unknown']);
    renderTable('#openports',['Port','Service'], ports);
    return ports;
  }catch(e){
    renderTable('#openports',['Port','Service'],[]);
    return [];
  }
}